-- PROJET SQL B2 - CLARA MOBILITY
-- Fichier simplifié pour montrer la structure de ma base.

-- ==========================================
-- 1. CRÉATION DES TABLES
-- ==========================================

-- D'abord les petites tables pour éviter les répétitions (Marques et Energies)
CREATE TABLE marques (
    id_marque SERIAL PRIMARY KEY,
    nom_marque VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE energies (
    id_energie SERIAL PRIMARY KEY,
    nom_energie VARCHAR(100) NOT NULL UNIQUE
);

-- La table principale : celle qui contient toute la flotte de voitures
CREATE TABLE vehicules (
    id_vehicule INTEGER PRIMARY KEY,
    modele VARCHAR(100),
    annee INTEGER,
    autonomie_km INTEGER,
    immatriculation VARCHAR(20) UNIQUE, -- Chaque plaque est unique, logique
    etat VARCHAR(50), -- Pour savoir si elle est dispo ou au garage
    localisation VARCHAR(100),
    id_marque INTEGER REFERENCES marques(id_marque), -- Lien vers la marque
    id_energie INTEGER REFERENCES energies(id_energie) -- Lien vers l'énergie
);

-- Table des clients
CREATE TABLE utilisateurs (
    id_utilisateur SERIAL PRIMARY KEY,
    nom VARCHAR(100),
    prenom VARCHAR(100),
    email VARCHAR(150) UNIQUE, -- Pas de doublon d'email
    ville VARCHAR(100),
    date_inscription DATE
);

-- Table des réservations (le lien entre clients et voitures)
CREATE TABLE reservations (
    id_reservation SERIAL PRIMARY KEY,
    date_debut TIMESTAMP,
    date_fin TIMESTAMP,
    statut VARCHAR(50) DEFAULT 'Terminée',
    cout_total DECIMAL(10, 2),
    id_utilisateur INTEGER REFERENCES utilisateurs(id_utilisateur),
    id_vehicule INTEGER REFERENCES vehicules(id_vehicule)
);

-- ==========================================
-- 2. PARTIE AVANCÉE (VUES & TRIGGERS)
-- ==========================================

-- Ma Vue pour afficher les factures avec les noms (plus lisible que des ID)
CREATE OR REPLACE VIEW vue_details_reservations AS
SELECT 
    r.id_reservation,
    u.nom || ' ' || u.prenom AS client, -- Je colle nom et prénom ensemble
    m.nom_marque || ' ' || v.modele AS voiture,
    r.date_debut,
    r.cout_total,
    r.statut
FROM reservations r
JOIN utilisateurs u ON r.id_utilisateur = u.id_utilisateur
JOIN vehicules v ON r.id_vehicule = v.id_vehicule
JOIN marques m ON v.id_marque = m.id_marque;

-- Mon Trigger de sécurité
-- Il sert à bloquer la réservation si la voiture est en panne
CREATE OR REPLACE FUNCTION verif_disponibilite() RETURNS TRIGGER AS $$
DECLARE
    etat_actuel VARCHAR;
BEGIN
    -- Je récupère l'état de la voiture qu'on essaie de louer
    SELECT etat INTO etat_actuel FROM vehicules WHERE id_vehicule = NEW.id_vehicule;
    
    -- Si ce n'est pas "Disponible", je lance une erreur et je stop tout.
    IF etat_actuel != 'Disponible' THEN
        RAISE EXCEPTION 'Impossible de réserver : ce véhicule est actuellement % !', etat_actuel;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- J'active le trigger avant chaque insertion dans la table réservations
CREATE TRIGGER trigger_check_dispo
BEFORE INSERT ON reservations
FOR EACH ROW
EXECUTE FUNCTION verif_disponibilite();
